{% extends "base.html" %}

{% block title %}Visualización Año Completo 2024 (PM2.5 y PM10){% endblock %}

{% block extra_css %}
<style>
    .plot-container {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        margin-bottom: 2rem;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-overlay.active {
        display: flex;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }
    .metric-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    .quick-selection {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 2rem;
    }
    .quick-selection .btn {
        min-width: 160px;
        margin: 0.25rem;
    }
    .plot-container.small {
        padding: 1rem 1.25rem;
    }
    .comparison-plot {
        min-height: 320px;
    }
    .device-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .device-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .device-card.selected {
        border-color: var(--primary-green);
        background-color: #f0fdf4;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center text-white">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="mt-3" id="loadingMessage">Cargando datos...</h4>
    </div>
</div>

<!-- Hero Section -->
<section class="hero" style="padding: 3rem 0;">
    <div class="container">
        <h1>
            <i class="bi bi-calendar-range"></i>
            Visualización Año Completo 2024
        </h1>
        <p class="lead">
            Análisis individual de sensores y calibración - Periodo: 1 enero - 31 diciembre 2024
        </p>
    </div>
</section>

<!-- Selección de Dispositivo -->
<section class="section">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-hdd-rack"></i>
            Paso 1: Selecciona un Dispositivo
        </h3>

        <div class="quick-selection">
            <div class="btn-group flex-wrap justify-content-center" role="group" id="quickViewButtons">
                <button type="button" class="btn btn-outline-success quick-view-btn" data-device="Aire2" data-type="sensor">
                    <i class="bi bi-cpu"></i> Aire2
                </button>
                <button type="button" class="btn btn-outline-success quick-view-btn" data-device="Aire4" data-type="sensor">
                    <i class="bi bi-cpu"></i> Aire4
                </button>
                <button type="button" class="btn btn-outline-success quick-view-btn" data-device="Aire5" data-type="sensor">
                    <i class="bi bi-cpu"></i> Aire5
                </button>
                <button type="button" class="btn btn-outline-warning quick-view-btn" data-device="RMCAB_MinAmb" data-type="rmcab" data-station="9">
                    <i class="bi bi-building"></i> RMCAB Min Ambiente
                </button>
                <button type="button" class="btn btn-outline-secondary quick-view-btn" data-view="comparison">
                    <i class="bi bi-grid-3x3-gap-fill"></i> Comparar 4 Sensores
                </button>
            </div>
            <small class="text-muted mt-2 text-center">
                Usa los botones para cargar rápidamente cada sensor o visualizar los cuatro al tiempo.
            </small>
        </div>
        <div class="d-flex justify-content-center gap-2 mt-3 flex-wrap">
            <button class="btn btn-outline-primary btn-sm" id="btnLoadDevice" disabled>
                <i class="bi bi-arrow-clockwise"></i> Recargar último dispositivo
            </button>
            <button class="btn btn-success btn-sm" id="btnStartCalibration" disabled>
                <i class="bi bi-cpu-fill"></i> Ejecutar Calibración ML
            </button>
            <button class="btn btn-primary btn-lg" id="multipleCalibrationBtn">
                <i class="bi bi-cpu-fill"></i> Calibrar Todos (PM2.5 y PM10)
            </button>
        </div>
    </div>
</section>

<!-- Vista Comparativa de Sensores -->
<section class="section bg-light" id="multiSensorSection" style="display: none;">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-grid-1x2-fill"></i>
            Paso 2: Comparativa de Sensores (Año 2024)
        </h3>
        <p class="text-muted">
            Observa simultáneamente los cuatro sensores para identificar patrones, brechas y coherencia frente a la estación de referencia RMCAB.
        </p>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>Aire2 - Serie de Tiempo</h5>
                    <div class="comparison-plot" id="comparisonPlotAire2"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>Aire4 - Serie de Tiempo</h5>
                    <div class="comparison-plot" id="comparisonPlotAire4"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>Aire5 - Serie de Tiempo</h5>
                    <div class="comparison-plot" id="comparisonPlotAire5"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>RMCAB Min Ambiente</h5>
                    <div class="comparison-plot" id="comparisonPlotRMCAB_MinAmb"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Visualización de Datos -->
<section class="section bg-light" id="dataSection" style="display: none;">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-graph-up"></i>
            Paso 2: Visualización de Datos - <span id="selectedDeviceName"></span>
        </h3>

        <!-- Métricas Resumen -->
        <div class="metrics-grid" id="metricsGrid"></div>

        <!-- Gráficos -->
        <div class="plot-container">
            <h5>Serie de Tiempo - PM2.5 y PM10</h5>
            <div id="timeSeriesPlot"></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="plot-container">
                    <h5>Distribución PM2.5</h5>
                    <div id="boxPlotPM25"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container">
                    <h5>Distribución PM10</h5>
                    <div id="boxPlotPM10"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Resultados de Calibración -->
<section class="section" id="calibrationSection" style="display: none;">
    <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
            <h3 class="mb-0">
                <i class="bi bi-bar-chart-line"></i>
                Resultados de Calibración
            </h3>
        </div>

        <div class="alert alert-info">
            <h5 class="mb-2">
                <i class="bi bi-info-circle-fill"></i>
                Referencia
            </h5>
            <ul class="mb-0">
                <li>El referente es la estación oficial RMCAB (Min Ambiente - Código 9).</li>
                <li><strong>R²</strong> cercano a 1 indica mejor ajuste; <strong>RMSE</strong> y <strong>MAE</strong> bajos implican menor error.</li>
                <li>Se muestra la fórmula de la Regresión Lineal y la dispersión real vs. calibrado.</li>
            </ul>
        </div>

        <!-- Pestañas de dispositivos -->
        <ul class="nav nav-tabs mb-4" id="calibrationDeviceTabs" role="tablist">
            <!-- Las pestañas se generarán dinámicamente -->
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="calibrationDeviceTabContent">
            <!-- El contenido se generará dinámicamente -->
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/visualizacion_2024.js') }}"></script>
{% endblock %}
