{% extends "base.html" %}

{% block title %}Visualización Junio-Julio 2025{% endblock %}

{% block extra_css %}
<style>
    .plot-container {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        margin-bottom: 2rem;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-overlay.active {
        display: flex;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }
    .metric-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    .quick-selection {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 2rem;
    }
    .quick-selection .btn {
        min-width: 160px;
        margin: 0.25rem;
    }
    .plot-container.small {
        padding: 1rem 1.25rem;
    }
    .comparison-plot {
        min-height: 320px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center text-white">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="mt-3" id="loadingMessage">Cargando datos...</h4>
    </div>
</div>

<!-- Hero Section -->
<section class="hero" style="padding: 3rem 0;">
    <div class="container">
        <h1>
            <i class="bi bi-calendar-range"></i>
            Visualización Junio-Julio 2025
        </h1>
        <p class="lead">
            Análisis individual de sensores y calibración - Periodo: 1 junio - 31 julio 2025
        </p>
    </div>
</section>

<!-- Selección de Dispositivo -->
<section class="section">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-hdd-rack"></i>
            Paso 1: Selecciona un Dispositivo
        </h3>

        <div class="quick-selection">
            <div class="btn-group flex-wrap justify-content-center" role="group" id="quickViewButtons">
                <button type="button" class="btn btn-outline-success quick-view-btn" data-device="Aire2" data-type="sensor">
                    <i class="bi bi-cpu"></i> Aire2
                </button>
                <button type="button" class="btn btn-outline-success quick-view-btn" data-device="Aire4" data-type="sensor">
                    <i class="bi bi-cpu"></i> Aire4
                </button>
                <button type="button" class="btn btn-outline-success quick-view-btn" data-device="Aire5" data-type="sensor">
                    <i class="bi bi-cpu"></i> Aire5
                </button>
                <button type="button" class="btn btn-outline-warning quick-view-btn" data-device="RMCAB_LasFer" data-type="rmcab">
                    <i class="bi bi-building"></i> RMCAB Las Ferias
                </button>
                <button type="button" class="btn btn-outline-secondary quick-view-btn" data-view="comparison">
                    <i class="bi bi-grid-3x3-gap-fill"></i> Comparar 4 Sensores
                </button>
                <button type="button" class="btn btn-outline-primary quick-view-btn" data-view="stage2">
                    <i class="bi bi-calendar-week"></i> Visualización etapa 2
                </button>
            </div>
            <small class="text-muted mt-2 text-center">
                Usa los botones para cargar r&aacute;pidamente cada sensor o visualizar los cuatro al tiempo.
            </small>
        </div>
        <div class="d-flex justify-content-center gap-2 mt-3 flex-wrap">
            <button class="btn btn-outline-primary btn-sm" id="btnLoadDevice" disabled>
                <i class="bi bi-arrow-clockwise"></i> Recargar último dispositivo
            </button>
            <button class="btn btn-success btn-sm" id="btnStartCalibration" disabled>
                <i class="bi bi-cpu-fill"></i> Ejecutar Calibración ML
            </button>
            <button class="btn btn-primary btn-lg" id="multipleCalibrationBtn">
                <i class="bi bi-cpu-fill"></i> Calibrar Todos (PM2.5 y PM10)
            </button>
            <button class="btn btn-warning btn-sm" id="btnPrediction" disabled>
                <i class="bi bi-graph-up-arrow"></i> Predicción con Modelo
            </button>
        </div>
    </div>
</section>

<!-- Vista Comparativa de Sensores -->
<section class="section bg-light" id="multiSensorSection" style="display: none;">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-grid-1x2-fill"></i>
            Paso 2: Comparativa de Sensores (Junio - Julio 2025)
        </h3>
        <p class="text-muted">
            Observa simult&aacute;neamente los cuatro sensores para identificar patrones, brechas y coherencia frente a la estaci&oacute;n de referencia RMCAB.
        </p>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>Aire2 - Serie de Tiempo</h5>
                    <div class="comparison-plot" id="comparisonPlotAire2"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>Aire4 - Serie de Tiempo</h5>
                    <div class="comparison-plot" id="comparisonPlotAire4"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>Aire5 - Serie de Tiempo</h5>
                    <div class="comparison-plot" id="comparisonPlotAire5"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container small">
                    <h5>RMCAB Las Ferias</h5>
                    <div class="comparison-plot" id="comparisonPlotRMCAB_LasFer"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Visualización de Datos -->
<section class="section bg-light" id="dataSection" style="display: none;">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-graph-up"></i>
            Paso 2: Visualización de Datos - <span id="selectedDeviceName"></span>
        </h3>

        <!-- Métricas Resumen -->
        <div class="metrics-grid" id="metricsGrid"></div>

        <!-- Gráficos -->
        <div class="plot-container">
            <h5>Serie de Tiempo - PM2.5 y PM10</h5>
            <div id="timeSeriesPlot"></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="plot-container">
                    <h5>Distribución PM2.5</h5>
                    <div id="boxPlotPM25"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plot-container">
                    <h5>Distribución PM10</h5>
                    <div id="boxPlotPM10"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Resultados de Calibración -->
<section class="section" id="calibrationSection" style="display: none;">
    <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
            <h3 class="mb-0">
                <i class="bi bi-bar-chart-line"></i>
                Resultados de Calibración
            </h3>
        </div>

        <div class="alert alert-info">
            <h5 class="mb-2">
                <i class="bi bi-info-circle-fill"></i>
                Referencia
            </h5>
            <ul class="mb-0">
                <li>El referente es la estación oficial RMCAB (Las Ferias).</li>
                <li><strong>R²</strong> cercano a 1 indica mejor ajuste; <strong>RMSE</strong> y <strong>MAE</strong> bajos implican menor error.</li>
                <li>Se muestra la fórmula de la Regresión Lineal y la dispersión real vs. calibrado.</li>
            </ul>
        </div>

        <!-- Pestañas de dispositivos -->
        <ul class="nav nav-tabs mb-4" id="calibrationDeviceTabs" role="tablist">
            <!-- Las pestañas se generarán dinámicamente -->
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="calibrationDeviceTabContent">
            <!-- El contenido se generará dinámicamente -->
        </div>
    </div>
</section>

<!-- Visualización etapa 2 -->
<section class="section bg-white" id="stage2Section" style="display: none;">
    <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
            <h3 class="mb-0">
                <i class="bi bi-calendar-check"></i>
                Visualización etapa 2 - Ventana óptima de 5 días
            </h3>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" id="stage2ReloadBtn">
                    <i class="bi bi-arrow-repeat"></i> Recalcular ventana
                </button>
            </div>
        </div>

        <div id="stage2AlertContainer"></div>

        <div class="row g-3 mb-4" id="stage2SummaryRow">
            <!-- Métricas de la ventana óptima -->
        </div>

        <div class="plot-container small mb-4">
            <h5>Consulta SQL ejecutada</h5>
            <div id="stage2QueryBox" class="small text-break"></div>
        </div>

        <div class="card border-0 shadow-sm mb-4 bg-light">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label" for="stage2StartDate">Inicio manual</label>
                        <input type="date" class="form-control" id="stage2StartDate" value="2023-06-22">
                    </div>
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label" for="stage2EndDate">Fin manual</label>
                        <input type="date" class="form-control" id="stage2EndDate" value="2023-06-25">
                    </div>
                    <div class="col-md-4 col-lg-3">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button class="btn btn-outline-primary w-100" id="stage2ApplyManualBtn">
                            <i class="bi bi-calendar-range"></i> Aplicar ventana manual
                        </button>
                    </div>
                </div>
                <small class="text-muted d-block mt-3">
                    Ajusta las fechas para analizar un intervalo específico (por ejemplo, del 21 al 25 de junio) y luego ejecuta la calibración.
                </small>
            </div>
        </div>

        <div class="plot-container mb-4">
            <h5>Densidad de registros por dispositivo</h5>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Dispositivo</th>
                            <th>Registros totales</th>
                            <th>PM2.5 válidos</th>
                            <th>PM10 válidos</th>
                        </tr>
                    </thead>
                    <tbody id="stage2DeviceTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="row g-4" id="stage2ChartsRow"></div>

        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mt-4 mb-3">
            <p class="mb-0 text-muted flex-grow-1">
                Ejecuta la calibración avanzada para comparar los algoritmos y descarga la ventana actual en Excel.
            </p>
            <div class="d-flex flex-column flex-sm-row gap-2">
                <button class="btn btn-outline-secondary" id="stage2DownloadBtn">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Descargar datos (Excel)
                </button>
                <button class="btn btn-success" id="stage2CalibrateBtn">
                    <i class="bi bi-cpu"></i> Ejecutar calibración etapa 2
                </button>
            </div>
        </div>

        <div id="stage2CalibrationResults" class="mt-4">
            <!-- Resultados de calibración etapa 2 -->
        </div>
    </div>
</section>

<!-- Sección de Predicción con Modelo -->
<section class="section bg-light" id="predictionSection" style="display: none;">
    <div class="container">
        <h3 class="mb-4">
            <i class="bi bi-graph-up-arrow"></i>
            Predicción con Modelo Calibrado
        </h3>

        <div class="alert alert-info">
            <h5 class="mb-2">
                <i class="bi bi-info-circle-fill"></i>
                ¿Qué es esto?
            </h5>
            <p class="mb-0">
                Esta herramienta te permite seleccionar una fecha específica y un sensor para realizar predicciones
                usando el modelo calibrado. El sistema comparará la predicción con los valores reales de RMCAB.
            </p>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Sensor</label>
                <select class="form-select" id="predictionDevice">
                    <option value="">Selecciona un sensor...</option>
                    <option value="Aire2">Aire2</option>
                    <option value="Aire4">Aire4</option>
                    <option value="Aire5">Aire5</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" id="predictionDate"
                       min="2025-01-01" max="2025-12-31" value="2025-06-15">
                <small class="text-muted">Cualquier fecha (no requiere datos reales)</small>
            </div>
            <div class="col-md-3">
                <label class="form-label">Contaminante</label>
                <select class="form-select" id="predictionPollutant">
                    <option value="pm25">PM2.5</option>
                    <option value="pm10">PM10</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="btnRunPrediction">
                    <i class="bi bi-play-fill"></i> Predecir
                </button>
            </div>
        </div>

        <!-- Fechas Sugeridas -->
        <div class="alert alert-info mt-3">
            <h6 class="mb-2"><i class="bi bi-calendar-check"></i> Fechas sugeridas con datos RMCAB disponibles:</h6>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-info suggested-date" data-date="2025-06-15">15 Jun 2025</button>
                <button class="btn btn-sm btn-outline-info suggested-date" data-date="2025-06-20">20 Jun 2025</button>
                <button class="btn btn-sm btn-outline-info suggested-date" data-date="2025-07-01">01 Jul 2025</button>
                <button class="btn btn-sm btn-outline-info suggested-date" data-date="2025-07-10">10 Jul 2025</button>
                <button class="btn btn-sm btn-outline-info suggested-date" data-date="2025-07-20">20 Jul 2025</button>
            </div>
            <small class="text-muted d-block mt-2">Haz clic en una fecha para seleccionarla automáticamente</small>
        </div>

        <!-- Campos de Entrada Manual (ocultos inicialmente) -->
        <div id="manualInputSection" style="display: none;" class="mt-3">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>No hay datos reales disponibles para esta fecha.</strong>
                <br>Ingresa valores estimados para realizar la predicción:
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" id="manualPollutantLabel">PM del Sensor (µg/m³)</label>
                    <input type="number" class="form-control" id="manualPMValue"
                           placeholder="Ej: 15.5" step="0.1" min="0" max="500" value="15.0">
                    <small class="text-muted">Valor típico en Bogotá: 10-30 µg/m³</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Temperatura (°C)</label>
                    <input type="number" class="form-control" id="manualTemperature"
                           placeholder="Ej: 14.0" step="0.1" min="-10" max="40" value="14.0">
                    <small class="text-muted">Promedio Bogotá: 8-20 °C</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Humedad Relativa (%)</label>
                    <input type="number" class="form-control" id="manualRH"
                           placeholder="Ej: 70.0" step="0.1" min="0" max="100" value="70.0">
                    <small class="text-muted">Promedio Bogotá: 60-85%</small>
                </div>
            </div>
            <div class="mt-2">
                <button class="btn btn-success" id="btnRunManualPrediction">
                    <i class="bi bi-calculator"></i> Predecir con Valores Manuales
                </button>
                <button class="btn btn-secondary" id="btnCancelManual">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
            </div>
        </div>

        <!-- Resultados de Predicción -->
        <div id="predictionResults" style="display: none;" class="mt-4">
            <div class="plot-container">
                <h5>Resultados de Predicción</h5>

                <!-- Métricas de Error -->
                <div id="predictionMetrics" class="metrics-grid mb-3"></div>

                <!-- Análisis Descriptivo -->
                <div id="predictionAnalysis" class="alert alert-light mb-3" style="display: none;">
                    <h6><i class="bi bi-bar-chart-line"></i> Análisis Descriptivo</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tbody id="descriptiveStatsTable"></tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <div id="improvementSummary"></div>
                        </div>
                    </div>
                </div>

                <!-- Interpretación -->
                <div id="predictionInterpretation" class="alert alert-success mb-3" style="display: none;"></div>

                <!-- Gráfico Serie de Tiempo -->
                <div id="predictionPlot" style="min-height: 400px;"></div>

                <!-- Gráfico de Dispersión -->
                <div id="scatterPlotContainer" style="display: none;" class="mt-3">
                    <h6>Dispersión: Predicción vs RMCAB</h6>
                    <div id="predictionScatterPlot" style="min-height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/visualizacion_junio_julio.js') }}"></script>
{% endblock %}
